---
description: كشف المناطق غير المحددة بدقة في ملف المواصفة الحالي بسؤال حتى 5 أسئلة توضيحية عالية الدقة ودمج الإجابات فوراً في ملف المواصفة (مواصفة.md).
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --paths-only
  ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

مدخلات المستخدم يمكن أن تصلك مباشرة من الوكيل أو كوسيط (Arguments) — **يجب** تقييمها قبل المتابعة (إن لم تكن فارغة).

مدخلات المستخدم:

$ARGUMENTS

الهدف: اكتشاف الغموض أو القرارات الناقصة في *مواصفة الميزة* النشطة ودمج التوضيحات مباشرة داخل ملف `مواصفة.md`.

ملاحظة: يجب إكمال هذه الدورة قبل تشغيل `/plan`. إذا صرّح المستخدم صراحةً بتجاوز التوضيح (استكشاف تجريبي مثلاً) يمكن الاستمرار لكن **يجب** تحذيرهم من ارتفاع مخاطر إعادة العمل لاحقاً.

## خطوات التنفيذ Execution Steps

1. شغّل `{SCRIPT}` مرة واحدة (وضع `--json --paths-only`) / (`-Json -PathsOnly`) واستخرج الحقول الدنيا:
   - `FEATURE_DIR`
   - `FEATURE_SPEC` (يجب أن يشير إلى مواصفة.md)
   - (اختياري) `IMPL_PLAN`, `TASKS` للاستخدام المتسلسل لاحقاً
   - عند فشل الـ JSON: أوقف التنفيذ واطلب من المستخدم إعادة تشغيل `/تحديد` (/specify) أو التحقق من بيئة الفرع.

2. حمّل ملف `مواصفة.md` ونفّذ فحص الغموض والتغطية باستخدام التصنيف التالي. لكل فئة ضع حالة: Clear / Partial / Missing (داخلياً). لا تُخرج الخريطة الخام ما لم لا تُطرح أسئلة.

   النطاق الوظيفي والسلوك:
   - أهداف المستخدم الجوهرية ومعايير النجاح
   - ما هو خارج النطاق (Out of Scope)
   - تمييز الأدوار / الشرائح (Personas)

   المجال ونموذج البيانات:
   - الكيانات، الخصائص، العلاقات
   - قواعد الهوية / التفرد
   - حالات الحياة / الانتقال
   - افتراضات الحجوم / السِعة

   التفاعل وتدفق الاستخدام:
   - الرحلات الحرجة (Critical Journeys)
   - حالات الخطأ / الفارغ / التحميل
   - إمكانية الوصول / الموطنة (A11y / i18n)

   السمات غير الوظيفية (الجودة):
   - الأداء (زمن استجابة، معدل Throughput)
   - القابلية للتوسع (أفقي/عمودي + حدود)
   - الاعتمادية والتوافر
   - الرصد والملاحظة (Logging / Metrics / Tracing)
   - الأمن والخصوصية (AuthN/Z، حماية البيانات، افتراضات التهديد)
   - الامتثال / اللوائح (إن وُجد)

   التكامل والاعتمادات الخارجية:
   - الخدمات الخارجية / أوضاع الفشل
   - صيغ الاستيراد / التصدير
   - افتراضات البروتوكول / الإصدارات

   الحالات الحدّية ومعالجة الإخفاق:
   - السيناريوهات السلبية
   - تحديد المعدل / الخنق
   - حل التعارض (مثل تحرير متزامن)

   القيود والمفاضلات:
   - قيود تقنية (لغة، تخزين، استضافة)
   - مفاضلات صريحة / بدائل مرفوضة

   المصطلحات والاتساق:
   - مسرد المصطلحات المعتمدة
   - تجنّب المرادفات / المصطلحات المحذوفة

   إشارات الإتمام:
   - إمكانية اختبار معايير القبول
   - مؤشرات تعريف “اكتمل” قابلة للقياس

   متفرقات / نواقص:
   - علامات TODO / قرارات غير محسومة
   - صفات مبهمة (“سهل”، “قوي”، “بديهي”) بلا قياس

   لكل فئة حالة Partial أو Missing تُولَّد فرصة سؤال ما لم:
   - الإجابة لن تغيّر التصميم أو التحقق بشكل مادي
   - الأفضل تأجيلها لمرحلة التخطيط (سجّل داخلياً)

3. توليد داخلي لقائمة مرشحة من الأسئلة (حد أقصى 5). لا تُظهر كل الأسئلة دفعة واحدة. القيود:
   - 5 أسئلة كحد أقصى للجلسة.
   - كل سؤال إما:
     * متعدد خيارات (2–5 خيارات حصرية)، أو
     * إجابة قصيرة (≤5 كلمات) ويُذكر: `Format: إجابة قصيرة (≤5 كلمات)`.
   - اختر فقط ما يؤثر فعلياً على: المعمارية، نموذج البيانات، تفصيل المهام، تصميم الاختبار، سلوك UX، الجاهزية التشغيلية، أو الامتثال.
   - حافظ على تنوع الفئات عالية الأثر.

4. حلقة طرح متسلسل:
   - اعرض سؤالاً واحداً فقط كل مرة.
   - للأسئلة متعددة الخيارات استخدم جدول:

     | الخيار | الوصف |
     |--------|-------|
     | A | ... |
     | B | ... |
     | C | ... |
     | Short | إجابة حرة (≤5 كلمات) |

   - بعد إجابة المستخدم:
     * تحقق من انطباقها مع خيار أو قيود الطول.
     * إن كانت مبهمة اطلب توضيحاً سريعاً (يبقى نفس السؤال).
     * عند قبولها: خزّن و انتقل للسؤال التالي.
   - توقف عند:
     * حل كل الغموض الحرج مبكراً
     * إشارة المستخدم للتوقف (done / stop / لا مزيد)
     * بلوغ 5 أسئلة

5. الدمج بعد كل إجابة:
   - تأكد من وجود قسم `## Clarifications` وإلا أنشئه بعد القسم الافتتاحي.
   - أضف تحتَه: `### Session YYYY-MM-DD` (إن لم يوجد لليوم).
   - أضف سطراً: `- Q: <السؤال> → A: <الإجابة>`.
   - طبّق التغيير في القسم الأنسب:
     * وظيفي → تحديث / إضافة بند في المتطلبات الوظيفية
     * أدوار / تفاعل → تحديث قصص المستخدم أو قسم الأدوار
     * نموذج بيانات → تعديل/إضافة في قسم البيانات
     * غير وظيفي → إضافة معيار قياسي (رقمي / قابل قياس)
     * حالة حدّية → إضافة نقطة في قسم الحالات الحدّية / معالجة الأخطاء
     * مصطلحات → توحيد المصطلح واستبدال القديم (احتفظ بإشارة `(سابقاً: "X")` مرة واحدة عند الحاجة)
   - احذف النص المتعارض القديم بدل التكرار.
   - اكتب الملف (حفظ ذرّي).

6. تحقق (بعد كل حفظ + في النهاية):
   - عدد الأسئلة المقبولة ≤ 5
   - لا توجد ازدواجية في قسم Clarifications
   - لا تبقى عبارات مبهمة كان يفترض حلّها
   - لا تناقض في الصياغة
   - البنية Markdown سليمة

7. اكتب المواصفة المحدثة إلى `FEATURE_SPEC` (مواصفة.md).

8. تقرير الإنهاء:
   - عدد الأسئلة
   - المسار
   - الأقسام التي عُدلت
   - جدول حالة الفئات (Resolved / Deferred / Clear / Outstanding)
   - توصية: متابعة `/plan` أو إعادة `/توضيح` لاحقاً
   - الأمر التالي المقترح

## قواعد السلوك Behavior Rules

- لا تُنشئ مواصفة جديدة إن غابت — اطلب تشغيل `/تحديد`.
- لا تتجاوز حد 5 أسئلة.
- لا تسأل أسئلة أسلوبية أو تفاصيل تنفيذية مبكرة.
- اجعل النتائج قابلة للتكرار (Deterministic).

السياق Context: {ARGS}

(ملاحظة توافق: يمكن استمرار استخدام الأمر باسم `/clarify` بينما اسم الملف عربي `توضيح.md`، ويمكن إضافة `/توضيح` لاحقاً في طبقة الأوامر.)
