---
description: تنفيذ تحليل غير هدّام للاتساق والجودة عبر (مواصفة.md، تخطيط.md، مهام.md) بعد توليد المهام.
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

مدخلات المستخدم يمكن أن تصل إليك مباشرة من الوكيل (Agent) أو كوسيط (Arguments) في الأمر — **يجب** أخذها بالاعتبار قبل توليد المخرجات (إن وُجدت).

مدخلات المستخدم:

$ARGUMENTS

الهدف: اكتشاف عدم الاتساق، والتكرار، والالتباس، ونقاط النقص في الوضوح بين الوثائق الأساسية الثلاث: `مواصفة.md` و`تخطيط.md` و`مهام.md` قبل التنفيذ. يجب تشغيل هذا الأمر فقط بعد أن يُنتج أمر `/tasks` ملف `مهام.md` كاملاً.

وضع القراءة فقط STRICTLY READ-ONLY: **ممنوع** تعديل أي ملف. أخرج تقرير تحليل مُنظّم. اعرض خطة معالجة اختيارية (لا تُنفَّذ إلا بعد موافقة صريحة من المستخدم وبتحفيز يدوي).

سلطة الدستور Constitution Authority: ملف الدستور (`/memory/constitution.md`) غير قابل للتجاوز ضمن نطاق هذا التحليل. أي تعارض معه يُصنَّف CRITICAL ويستلزم تعديل (المواصفة أو الخطة أو المهام) — وليس إضعاف مبدأٍ دستوري أو تجاهله. إن احتاج مبدأ لتغيير جذري فذلك يتم في عملية صريحة منفصلة خارج `/تحليل` (/analyze).

## خطوات التنفيذ Execution Steps

1. شغّل `{SCRIPT}` مرة واحدة من جذر المستودع و解析 (Parse) الـ JSON لاستخراج: `FEATURE_DIR` و `AVAILABLE_DOCS`. اشتق المسارات المطلقة:
   - SPEC = FEATURE_DIR/مواصفة.md
   - PLAN = FEATURE_DIR/تخطيط.md
   - TASKS = FEATURE_DIR/مهام.md  
   إن غاب أي ملف مطلوب: انهِ العملية برسالة خطأ تطلب تشغيل الأمر السابق المناسب.

2. حمّل الوثائق:
   - تحليل أقسام `مواصفة.md`: (نظرة عامة/سياق، المتطلبات الوظيفية، غير الوظيفية، قصص المستخدم، الحالات الحدّية)
   - تحليل `تخطيط.md`: الاختيارات المعمارية/التقنية، مرجع نموذج البيانات، المراحل، القيود الفنية.
   - تحليل `مهام.md`: معرفات المهام، الوصف، تجميع المراحل، مؤشرات التوازي `[P]`, المسارات المشار إليها.
   - تحميل الدستور `/memory/constitution.md` للتحقق من المبادئ.

3. بناء نماذج دلالية داخلية:
   - قائمة المتطلبات: كل (وظيفي + غير وظيفي) مع مفتاح ثابت (Slug) مشتق من الجملة الأمرية (مثال: "يُمكن للمستخدم رفع ملف" → `user-can-upload-file`)
   - قائمة قصص / أفعال المستخدم.
   - خريطة تغطية المهام: كل مهمة ← مجموعة متطلبات/قصص (بالاستدلال عبر الكلمات المفتاحية أو إشارات صريحة).
   - مجموعة قواعد الدستور: أسماء المبادئ وكل الصياغات الإلزامية MUST / SHOULD.

4. نطاق الكشف (Detection Passes):
   A. التكرار Duplication:
      - اكتشاف المتطلبات المتقاربة دلالياً. تعليم الأضعف لدمجه.
   B. الالتباس Ambiguity:
      - وسم الصفات المبهمة (سريع، آمن، مرن، قوي...) دون معيار قياس.
      - وسم العلامات غير المحسومة (TODO, TKTK, ???, <placeholder> ...).
   C. نقص التحديد Underspecification:
      - متطلب يحوي فعل بدون موضوع واضح أو ناتج قابل للقياس.
      - قصة مستخدم بلا ربط بمعايير قبول.
      - مهمة تشير إلى ملف/مكوّن غير معرّف في المواصفة أو الخطة.
   D. التوافق الدستوري Constitution Alignment:
      - أي بند يتعارض مع مبدأ MUST.
      - أقسام إلزامية مفقودة فرضها الدستور.
   E. فجوات التغطية Coverage Gaps:
      - متطلبات بلا أي مهام مرتبطة.
      - مهام دون ربط بمتطلب أو قصة.
      - متطلبات غير وظيفية بلا مهام (أداء، أمن...).
   F. عدم الاتساق Inconsistency:
      - انزلاق المصطلحات (مفهوم واحد بأكثر من تسمية).
      - كِيانات بيانات في الخطة لا تظهر في المواصفة أو العكس.
      - ترتيب مهام غير منطقي (تكامل قبل الأساسيات) دون توضيح تبعية.
      - تعارض قرارات (مثال: إطاران مختلفان متعارضان).

5. تصنيف الشدة Severity:
   - CRITICAL: تعارض دستور MUST، غياب وثيقة أساسية، متطلب بلا أي تغطية يوقف الأساس.
   - HIGH: تكرار/تعارض، غموض أمني/أداء، معيار قبول غير قابل للاختبار.
   - MEDIUM: انزلاق مصطلحات، نقص تغطية غير وظيفية، حالة حدّية ناقصة.
   - LOW: تحسين صياغة، تكرار طفيف لا يؤثر على التنفيذ.

6. إنتاج تقرير Markdown (بدون كتابة ملفات) يحوي:
   ### تقرير تحليل المواصفة
   | ID | التصنيف | الشدة | الموقع | الملخص | التوصية |
   |----|---------|-------|--------|--------|---------|
   | A1 | Duplication | HIGH | مواصفة.md:L120-134 | متطلبان متشابهان ... | دمج الصياغة والإبقاء على الأدق |

   أقسام إضافية:
   - جدول التغطية Coverage:
     | Requirement Key | Has Task? | Task IDs | Notes |
   - تعارضات الدستور (إن وجدت)
   - مهام غير مُربوطة
   - إحصائيات Metrics:
     * إجمالي المتطلبات
     * إجمالي المهام
     * نسبة التغطية (≥1 مهمة)
     * عدد الغموض
     * عدد التكرار
     * عدد القضايا الحرجة

7. في نهاية التقرير اخرج كتلة إجراءات تالية Next Actions:
   - إن وُجدت CRITICAL: أوقف واطلب المعالجة قبل `/implement`.
   - إن كانت LOW/MEDIUM فقط: السماح بالمتابعة مع تحسينات مقترحة.
   - اقترح أوامر صريحة: مثل "شغّل /specify لتحسين..."، "شغّل /plan لتعديل المعمارية"، "حرر مهام.md لإضافة تغطية لـ 'performance-metrics'".

8. اسأل: "هل تريد أن أقترح تعديلات علاجية ملموسة لأعلى N قضايا؟" (لا تطبق شيئاً تلقائياً).

## قواعد السلوك Behavior Rules

- ممنوع تعديل الملفات.
- ممنوع اختلاق أقسام غير موجودة – أعلن غيابها كما هي.
- يجب أن تكون النتائج حتمية (Deterministic) على نفس المدخلات.
- حد أقصى 50 بنداً في الجدول الرئيسي (الباقي يُلخّص).
- إن لم توجد أية قضايا: اخرج تقرير نجاح مع الإحصائيات وتوصية بالمتابعة.

السياق Context: {ARGS}

(ملاحظة: حفاظاً على التوافق مع المنظومة الحالية يمكن استمرار استدعاء الأمر باسم /analyze بينما اسم الملف عربي `تحليل.md`، ويمكن إضافة دعم `/تحليل` لاحقاً في طبقة الأوامر.)
