---
description: إنشاء أو تحديث دستور المشروع (constitution) عبر جمع/اشتقاق مبادئ حوكمة قابلة للاختبار ومزامنة تأثيرها على القوالب التابعة.
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --paths-only
  ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

مدخلات المستخدم يمكن أن تصلك مباشرة من الوكيل أو كوسيط (Arguments) — **يجب** تحليلها أولاً (إن لم تكن فارغة).

مدخلات المستخدم:

$ARGUMENTS

أنت مسؤول عن تحديث ملف الدستور الموجود في: `/memory/constitution.md`. الملف عبارة عن قالب يحوي رموز placeholders مربعة مثل `[PROJECT_NAME]`, `[PRINCIPLE_1_NAME]`. المطلوب:  
1) جمع أو اشتقاق القيم  
2) استبدالها بدقة  
3) نشر (Propagate) أي تعديلات إلى القوالب/الملفات التابعة عند الحاجة (مع تقرير التأثير).

## سير التنفيذ Execution Flow

### 1. تحميل القالب واستخراج الـ Placeholders
- اقرأ `/memory/constitution.md`.
- استخرج كل الرموز المطابقة للنمط `[ALL_CAPS_IDENTIFIER]`.
- قد يطلب المستخدم عدداً مختلفاً من المبادئ عن عدد الأقسام الحالية. احترم العدد المطلوب وكيّف البنية (إضافة / إزالة مبادئ).

### 2. جمع القيم لكل Placeholder
مصادر القيم بالترتيب:
1. مدخل المستخدم الحالي (إن وفر قيمة صريحة).
2. سياق المستودع (README, docs, آخر نسخة محفوظة من الدستور داخل نفس الملف إن كانت موجودة).
3. الاشتقاق المنطقي.

قواعد خاصة:
- `RATIFICATION_DATE`: تاريخ الاعتماد الأول (إن غير معروف اترك TODO مبرر).
- `LAST_AMENDED_DATE`: تاريخ اليوم إذا حصل تعديل فعلي، وإلا احتفظ بالقيمة السابقة.
- قرار ترقية الإصدار `CONSTITUTION_VERSION` (Semantic Versioning):
  * MAJOR: تغييرات كسرية في الحوكمة / حذف أو إعادة تعريف مبدأ جذري.
  * MINOR: إضافة مبدأ جديد أو توسعة مادية (Material Expansion).
  * PATCH: تحسين صياغة/إيضاحات دون أثر حوكمي.
- إن كان نوع الترقية ملتبساً: فسّر المنطق قبل تثبيته (داخل التقرير التعليقي).

### 3. صياغة المحتوى النهائي
- استبدل كل Placeholder بنص نهائي (لا تترك أقواساً إلا إن تقرر صراحةً تأجيله مع `TODO(IDENT): سبب`).
- كل مبدأ:  
  - اسم مختصر حتمي (سطر عنوان)  
  - فقرة أو قائمة قواعد MUST/SHOULD واضحة قابلة للاختبار  
  - Rationale (اختياري إن لم يكن الاسم كافياً)
- قسم الحوكمة Governance: يوضّح آلية التعديل، سياسة الإصدار، المراجعات الدورية للامتثال.

### 4. مزامنة الاتساق Consistency Propagation
تحقق مما إذا كانت التعديلات تتطلب تغييراً في القوالب التالية، واقرأها (لا تعدلها هنا، فقط علّق حالة التزامن):
- `/templates/plan-template.md`
- `/templates/spec-template.md`
- `/templates/tasks-template.md`
- كل ملفات الأوامر في `/templates/commands/*.md` لضمان عدم تناقض المصطلحات (مثل أسماء الملفات العربية: مواصفة.md، تخطيط.md، مهام.md).
- `README.md`, `docs/` (مثلاً: `docs/quickstart.md`, `docs/installation.md`, …)

سجّل ما إذا كان كل ملف:
- ✅ محدث (لا يحتاج تعديل)
- ⚠ يحتاج تحديث لاحق
- ❌ متأثر لكن لا يمكن تعديل الآن (اشرح السبب)

### 5. تقرير تأثير (Sync Impact Report)
أضِف في أعلى الدستور (بعد التحديث) تعليق HTML على شكل:

```html
<!--
Constitution Sync Impact Report
Old Version: X.Y.Z
New Version: A.B.C
Version Bump Type: MAJOR|MINOR|PATCH (Reason: ...)

Modified Principles:
- Old Title 1 -> New Title 1 (إن أعيدت تسمية)
- Updated: Principle 2 (توسعة/إعادة صياغة)

Added Principles:
- Principle N: Title

Removed Principles:
- Principle M (سبب الإزالة)

Template / File Sync Status:
- templates/plan-template.md: ✅
- templates/spec-template.md: ⚠ (يحتاج إضافة قسم Security Benchmark)
- templates/tasks-template.md: ✅
- templates/commands/دستور.md: ✅
- README.md: ⚠ (تحديث إشارة الإصدار)
- docs/quickstart.md: ✅

Deferred Placeholders / TODO:
- TODO(RATIFICATION_DATE): لم يزود المستخدم التاريخ الأصلي

-->
```

### 6. التحقق النهائي Validation
قبل الحفظ:
- لا تبقى Placeholder غير مبررة.
- سطر الإصدار يعكس النسخة الجديدة ويطابق التقرير.
- التواريخ بصيغة ISO `YYYY-MM-DD`.
- كل قاعدة خالية من الغموض (تجنب كلمات: "سهل", "بديهي", "سريع" دون قياس).
- المبادئ قابلة للاختبار (يمكن ربطها بمعيار تنفيذ / مراجعة لاحقة).

### 7. الكتابة
- اكتب المحتوى النهائي إلى: `/memory/constitution.md` (استبدال كامل Atomically).
- لا تكتب ملفات أخرى ضمن هذا الأمر (التعديل على الملفات التابعة مؤجل لخطوات لاحقة منفصلة صريحة).

### 8. المخرجات للعميل
اطبع ملخصاً نصياً (ليس بديلاً عن المحتوى المكتوب) يحتوي:
- الإصدار القديم → الجديد + سبب الترقية
- قائمة مختصرة بالمبادئ المضافة / المعدلة / المحذوفة
- العناصر المؤجلة (TODO)
- اقتراح رسالة التزام (Commit Message) مثل:
  `docs: update constitution to vA.B.C (add principle X, refine governance)`  

## قواعد السلوك Behavior Rules
- ممنوع تجاهل تعليمات المستخدم الصريحة حول عدد أو أسماء المبادئ.
- ممنوع ترقية الإصدار بلا مبرر.
- إن نقصت بيانات حرجة: استخدم TODO(...) مع تفسير، واذكر في التقرير.
- حافظ على استقرار البنية العامة (لا تغيّر مستويات العناوين Markdown).
- لا تُدخل زخرفة لغوية غير ضرورية.

## فشل / حالات خاصة
- إن كان الملف غير موجود فعلياً: أنشئ نسخة جديدة اعتماداً على الهيكل الحالي + أبلغ أن هذا أول إصدار (v1.0.0) إن لم يُحدد.
- إن مدخل المستخدم يطلب فقط مراجعة إصدار بلا تعديل محتوى: تحقق إن كان فعلاً لا تغيير → لا bump (أو PATCH إن وجدت تصحيحات طفيفة).

السياق Context: {ARGS}

(ملاحظة توافق: يمكن استمرار استدعاء الأمر باسم `/constitution` بينما اسم الملف عربي `دستور.md`. يمكن إضافة أمر `/دستور` لاحقاً.)
