---
description: تنفيذ مسار إعداد خطة التنفيذ باستخدام قالب التخطيط لإنتاج المخرجات التصميمية المرحلية.
scripts:
  sh: scripts/bash/setup-plan.sh --json
  ps: scripts/powershell/setup-plan.ps1 -Json
---

مدخلات المستخدم (إن وُجدت) قد تصلك مباشرة من الوكيل أو كوسيط في الأمر — **يجب** أخذها في الاعتبار قبل المتابعة.

مدخلات المستخدم:

$ARGUMENTS

الغرض: توليد خطة تنفيذ تفصيلية ومخرجات داعمة (بحث، نموذج بيانات، عقود، بدء سريع، مهام) استناداً إلى المواصفة والدستور وبدرجة وضوح تقلّل إعادة العمل.

## 1. إعداد السياق

1. شغّل `{SCRIPT}` من جذر المستودع وحلّل JSON لاستخراج:
   - `FEATURE_SPEC`
   - `IMPL_PLAN`
   - `SPECS_DIR`
   - `BRANCH`
2. يجب أن تكون جميع المسارات لاحقاً مطلقة (Absolute) انطلاقاً من جذر المستودع.

## 2. تحقق من الجاهزية (Clarifications Gate)

قبل المتابعة:
- افحص وجود قسم `## Clarifications` في `FEATURE_SPEC` مع الأقل `### Session` واحدة.
- إذا غاب أو توجد عبارات غامضة حرجة (صفات مبهمة، قرارات معمارية غير محسومة):  
  - توقف ووجّه المستخدم لتشغيل `/توضيح` (`/clarify`) أولاً، ما لم يوفّر المستخدم تجاوزاً صريحاً (مثل: "proceed without clarification").
- ممنوع اختلاق توضيحات غير موجودة.

## 3. تحليل المواصفة

حمّل `FEATURE_SPEC` وحدد:
- المتطلبات الوظيفية وغير الوظيفية.
- قصص / سيناريوهات المستخدم.
- معايير القبول والنجاح.
- القيود التقنية والاعتمادات.
- أي فجوات ظاهرة (تُسجّل لمخرجات البحث Phase 0 إن لزم).

## 4. قراءة الدستور

اقرأ `/memory/constitution.md` واعتمد:
- المبادئ الإلزامية (MUST) التي تؤثر على بنية الخطة.
- أي أقسام مفروضة (مثال: قابلية الاختبار، المراقبة، الأمن) لضمان ظهورها في مراحل الخطة.

## 5. تشغيل قالب الخطة

قالب الخطة موجود مسبقاً في `IMPL_PLAN` (منسوخ من `/templates/plan-template.md`).  
نفّذ التسلسل (Phases) كما يحدده القالب (أمثلة نموذجية):

Phase 0 (استقصاء / Research):
- توليد `بحث.md` عند الحاجة، تجميع المخاطر، البدائل، القرارات المؤجلة.

Phase 1 (نموذج البيانات والعقود والبنية):
- توليد `نموذج-البيانات.md` (كيانات، خصائص، علاقات، قيود).
- إنشاء مجلد `العقود/` (API / بروتوكولات / صيغ تبادل) عند الحاجة.
- توليد `بدء-سريع.md` (Quickstart) يصف تركيب وتشغيل الميزة.
- تحديث أقسام المعمارية في `تخطيط.md`.

Phase 2 (مهام):
- اشتقاق / تحديث `مهام.md`:
  - تقسيم إلى مراحل (Setup / Core / Integration / Tests / Polish) أو ما يلائم.
  - تعيين معرفات (T1, T2, …).
  - وضع `[P]` للمهام التي يمكن تنفيذها بالتوازي.
  - ربط كل مهمة بمتطلب/قصة/مبدأ (إن أمكن) لتعزيز التتبع.

(إن تضمن القالب Phases إضافية اتبعها حرفياً).

## 6. دمج مدخلات المستخدم

أي معطيات بنيوية / تقنية في `$ARGUMENTS` تُدمج في:
- قسم السياق التقني (Technical Context).
- تكييف القرارات (مثلاً اختيار إطار، مكتبات، نمط تخزين).
- تبرير المفاضلات (Trade-offs) إن زُوّدت.

## 7. آليات الحماية والتحقق (Gate Checks)

بعد كل مرحلة:
- تحقق من إنتاج الملفات المتوقعة (لا تترك ملفات فارغة بلا مبرر).
- سجّل تقدم (داخل الخطة) إن كان القالب يدعم "Progress Tracking".
- عند فشل توليد ملف حرج (مثلاً نموذج البيانات) مع نقص مبررات:
  - ضع ملاحظة TODO ضمن `تخطيط.md` + اقترح العودة لـ `/توضيح` أو `/تحليل`.

## 8. معايير اكتمال الخطة

تُعتبر الخطة صالحة للانتقال إلى `/تنفيذ` إذا:
- ملف `تخطيط.md` يحتوي أقسام معمارية واضحة + قراراتها.
- `نموذج-البيانات.md` (إن لزم) يحدد الكيانات الأساسية بلا غموض هيكلي.
- `العقود/` (إن لزم) تحتوي مسودات أو مواصفات قابلة للتطوير التدريجي.
- `مهام.md` يغطي كل المتطلبات الحرجة (لا متطلب وظيفي رئيسي بلا مهمة).
- تم توثيق مخاطر مفتوحة / قرارات مؤجلة في قسم واضح أو في `بحث.md`.
- لا توجد تحذيرات حرجة متبقية في Gate Checks.

## 9. إخراج تقرير النتيجة

أخرج (خارجياً):
- الفرع `BRANCH`
- قائمة المخرجات المنتجة (وجود/عدم وجود):
  - مواصفة (للمرجع فقط)
  - تخطيط.md
  - بحث.md
  - نموذج-البيانات.md
  - العقود/ (عدد الملفات)
  - بدء-سريع.md
  - مهام.md
- ملخص عدد المهام وإجمالي المراحل
- TODOs إن وُجدت (مجمّعة)

## 10. سلوك وحدود

- ممنوع تعديل المواصفة (ذلك يحصل عبر `/توضيح` أو إعادة `/تحديد`).
- لا تُضيف متطلبات جديدة من العدم — إن ظهر متطلب جديد نتيجة فهم معماري، سجّل ملاحظة "Candidate Requirement" ولا تُثبته بلا دورة توضيح.
- حافظ على الحتمية (نفس الإدخال → نفس الخرج).
- استخدم أسماء الملفات العربية (مواصفة.md، تخطيط.md، مهام.md، …) تطابق التغييرات الجارية.

## 11. أخطاء شائعة وتعامل

| الحالة | الإجراء |
|--------|---------|
| غياب Clarifications | اطلب `/توضيح` قبل المتابعة |
| فشل توليد نموذج-البيانات | ضع TODO ووسم الخطر + اقترح جلسة تحليل |
| تعارض في العقود | سجّل ملاحظة وادفع لتجزئة العقد أو قرار فني |
| نقص تغطية مهام لمتطلب | أضف TODO في `مهام.md` لتوليد مهمة لاحقة أو راجع المواصفة |

## 12. الإخراج النهائي

في نهاية التنفيذ:
- لا تُعدل ملفات أخرى خارج النطاق المذكور.
- اقترح الأمر التالي المنطقي: `/تحليل` للتحقق، أو مباشرة `/تنفيذ` إن امتلأت الشروط.

ملاحظة توافق: يمكن استدعاء الأمر باسم `/plan` بينما اسم الملف عربي `تخطيط.md`، ويمكن دعم `/تخطيط` لاحقاً.

السياق Context: {ARGS}
